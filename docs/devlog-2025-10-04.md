# 开发日志（2025-10-04）

时间：2025-10-04 00:40 +09:00
仓库：tonywei17/ai_profile（本地路径：`/Users/wenxinwei/ai_profile`）

## 本次变更摘要
- **[项目生成]** 通过 XcodeGen 生成 Xcode 工程 `AIIDPhoto.xcodeproj`（`project.yml`）。
- **[iOS 16 适配]** 修复 `onChange(of:)` 与 `ShapeStyle` 类型推断问题，保证 iOS 16 编译通过。
  - 文件：`ios/AIIDPhoto/ContentView.swift`、`GlassButtonStyle`（同文件内）
- **[UI 修复]** 修正早期补丁造成的花括号错位，恢复 `glassCard` 结构。
  - 文件：`ios/AIIDPhoto/ContentView.swift`
- **[官方接口接入 - 方案A2（图到图）]**
  - 切换端点到官方 Image Generation（图像模型）以支持“图到图/编辑”。
  - `GEMINI_ENDPOINT` 设为：
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent`
  - 使用 `x-goog-api-key` 头传递密钥，不再走 `?key=` 或 Bearer。
  - 请求体遵循官方示例：`contents.parts` 中包含 `text` 与 `inline_data{ mime_type, data }`（图片 base64）。
  - 解析响应：从 `candidates[0].content.parts[*].inline_data.data` 提取图片 base64。
  - 文件：`ios/AIIDPhoto/Services/GeminiService.swift`、`project.yml`
- **[错误可观测性]** 非 200 HTTP 返回时，解析 `{ error: { code, message } }`，将 message 显示到弹窗，便于排查。
  - 文件：`ios/AIIDPhoto/Services/GeminiService.swift`
- **[生成指令输入]** 新增“生成指令”输入框，传入到服务端。
  - 文件：`ios/AIIDPhoto/ContentView.swift`

## 主要修改文件与路径
- `project.yml`
- `ios/AIIDPhoto/ContentView.swift`
- `ios/AIIDPhoto/Services/GeminiService.swift`

## 运行验证
1. 执行 `xcodegen generate` 同步工程（已多次执行）。
2. `xcodebuild -project AIIDPhoto.xcodeproj -scheme AIIDPhoto -configuration Debug -destination 'platform=iOS Simulator,name=iPhone 16e' -derivedDataPath build clean build`（已通过）。
3. 启动 iOS 模拟器，将一张图片拖入“照片”App。
4. 在 App：
   - 输入“生成指令”（可用默认：浅色纯色背景，35x45mm，正脸居中等）。
   - 选择相册图片，点击“生成证件照”。
5. 若失败，弹窗会显示如 `HTTP 400/401/403/429: <message>` 的详细信息。

## 注意事项
- 目前 `GEMINI_API_KEY` 写在 Info.plist（通过 `project.yml` 注入），仅适合本地调试。生产建议使用服务端代理持有密钥。
- 如果接口返回 400 且提示 MIME 类型限制，请确认端点为 Image Generation（图像模型）而非 `generateContent` 的文本多模态模型。
- 如果返回 401/403/429，请检查 Key 权限、计费与配额。

## 后续可选路线
- 接入 AdMob（SPM），或继续保持条件编译占位。
- 将 `GEMINI_API_KEY` 改为 `.xcconfig` 或环境注入，避免泄露。
- 若要支持“本地代理”或非 HTTPS，需要在 Info.plist 添加 ATS 例外项。

---
变更由 AI 助手驱动并在本地验证构建通过。如需更详细的接口日志或切换其他图像模型端点，请提出需求。
